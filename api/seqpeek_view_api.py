"""

Copyright 2015, Institute for Systems Biology

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

"""

import logging

from endpoints import method as endpoints_method
from endpoints import InternalServerErrorException
from protorpc import remote
from protorpc.messages import IntegerField, Message, MessageField, StringField, Variant

from bq_data_access.seqpeek.seqpeek_view import SeqPeekViewDataBuilder
from bq_data_access.data_access import get_feature_vectors_tcga_only
from api.seqpeek_api import SeqPeekDataEndpointsAPI, MAFRecord, maf_array_to_record
from bq_data_access.seqpeek.seqpeek_maf_formatter import SeqPeekMAFDataFormatter
from bq_data_access.seqpeek_maf_data import SeqPeekDataProvider
from bq_data_access.data_access import ProviderClassQueryDescription
from api.data_access import fetch_isbcgc_project_set
from api.api_helpers import sql_connection

from projects.models import Project

class SeqPeekViewDataRequest(Message):
    hugo_symbol = StringField(1, required=True)
    cohort_id = IntegerField(2, repeated=True)


class InterproMatchLocation(Message):
    # TODO this should likely be a float
    score = IntegerField(1, variant=Variant.INT32)
    start = IntegerField(2, variant=Variant.INT32)
    end = IntegerField(3, variant=Variant.INT32)


class InterproMatch(Message):
    status = StringField(1)
    name = StringField(2)
    evd = StringField(3)
    locations = MessageField(InterproMatchLocation, 4, repeated=True)
    dbname = StringField(5)
    id = StringField(6)


class InterproJson(Message):
    matches = MessageField(InterproMatch, 1, repeated=True)
    uniprot_id = StringField(2)
    length = IntegerField(3, variant=Variant.INT32)
    name = StringField(4)


class InterproItem(Message):
    uniprot_id = StringField(1)
    interpro_json = MessageField(InterproJson, 2, repeated=False)


class SeqPeekRegionRecord(Message):
    type = StringField(1, required=True)
    start = IntegerField(2, required=True, variant=Variant.INT32)
    end = IntegerField(3, required=True, variant=Variant.INT32)


class SeqPeekTrackRecord(Message):
    mutations = MessageField(MAFRecord, 1, repeated=True)
    type = StringField(2, required=True)
    label = StringField(3, required=True)
    number_of_samples = IntegerField(4, required=True)
    mutated_positions = IntegerField(5, required=True)
    cohort_size = IntegerField(6, required=False)
    row_id = StringField(7, required=True)


class SeqPeekViewPlotDataRecord(Message):
    tracks = MessageField(SeqPeekTrackRecord, 1, repeated=True)
    protein = MessageField(InterproItem, 2, required=False)
    regions = MessageField(SeqPeekRegionRecord, 3, repeated=True)


class SeqPeekRemovedRow(Message):
    name = StringField(1, required=True)
    num = IntegerField(2, required=True)


class SeqPeekViewRecord(Message):
    cohort_id_list = StringField(1, repeated=True)
    hugo_symbol = StringField(2, required=True)
    plot_data = MessageField(SeqPeekViewPlotDataRecord, 3, required=True)
    removed_row_statistics = MessageField(SeqPeekRemovedRow, 4, repeated=True)


def create_interpro_record(interpro_literal):
    match_data = []
    for match in interpro_literal['matches']:

        match_location_data = []
        for location in match['locations']:
            match_location_data.append(InterproMatchLocation(
                score=int(location['score']),
                start=int(location['start']),
                end=int(location['end'])
            ))

        match_data.append(InterproMatch(
            status=str(match['status']),
            name=str(match['name']),
            evd=str(match['evd']),
            locations=match_location_data,
            dbname=str(match['dbname']),
            id=str(match['id']),
        ))

    interpro_json = InterproJson(
        matches=match_data,
        uniprot_id=str(interpro_literal['uniprot_id']),
        length=int(interpro_literal['length']),
        name=str(interpro_literal['name'])
    )

    return InterproItem(
        interpro_json=interpro_json
    )


@SeqPeekDataEndpointsAPI.api_class(resource_name='data_endpoints')
class SeqPeekViewDataAccessAPI(remote.Service):
    def build_gnab_feature_id(self, gene_label):
        return "GNAB:{gene_label}:variant_classification".format(gene_label=gene_label)

    def create_response(self, seqpeek_view_data):
        plot_data = seqpeek_view_data['plot_data']
        tracks = []
        for track in plot_data['tracks']:
            mutations = maf_array_to_record(track['mutations'])
            tracks.append(SeqPeekTrackRecord(mutations=mutations, label=track['label'], type=track["type"],
                                             row_id=track['render_info']['row_id'],
                                             number_of_samples=track['statistics']['samples']['numberOf'],
                                             mutated_positions=track['statistics']['samples']['mutated_positions'],
                                             cohort_size=track['statistics']['cohort_size']))

        region_records = []
        for region in plot_data['regions']:
            region_records.append(SeqPeekRegionRecord(**region))

        protein = create_interpro_record(plot_data['protein'])
        plot_data_record = SeqPeekViewPlotDataRecord(tracks=tracks, protein=protein, regions=region_records)

        removed_row_statistics = []
        for item in seqpeek_view_data['removed_row_statistics']:
            removed_row_statistics.append(SeqPeekRemovedRow(**item))

        return SeqPeekViewRecord(plot_data=plot_data_record, hugo_symbol=seqpeek_view_data['hugo_symbol'],
                                 cohort_id_list=seqpeek_view_data['cohort_id_list'],
                                 removed_row_statistics=removed_row_statistics)

    @endpoints_method(SeqPeekViewDataRequest, SeqPeekViewRecord,
                      path='view_data', http_method='GET', name='seqpeek.getViewData')
    def seqpeek_view_data(self, request):
        try:
            hugo_symbol = request.hugo_symbol
            cohort_id_array = request.cohort_id

            gnab_feature_id = self.build_gnab_feature_id(hugo_symbol)
            logging.debug("GNAB feature ID for SeqPeke: {0}".format(gnab_feature_id))

            # Get the project IDs these cohorts' samples come from
            cohort_vals = tuple(int(i) for i in cohort_id_array)
            cohort_params = ('%s,' * len(cohort_id_array))[:-1]

            db = sql_connection()
            cursor = db.cursor()

            isbcgc_projects = fetch_isbcgc_project_set()

            cursor.execute("SELECT DISTINCT project_id FROM cohorts_samples WHERE cohort_id IN (%s);" % cohort_params,
                           cohort_vals)

            # Only samples whose source studies are TCGA studies, or extended from them, should be used
            confirmed_project_ids = []
            unconfirmed_project_ids = []

            for row in cursor.fetchall():
                if row[0] in isbcgc_projects:
                    if row[0] not in confirmed_project_ids:
                        confirmed_project_ids.append(row[0])
                elif row[0] not in unconfirmed_project_ids:
                    unconfirmed_project_ids.append(row[0])

            if len(unconfirmed_project_ids) > 0:
                projects = Project.objects.filter(id__in=unconfirmed_project_ids)

                for proj in projects:
                    if proj.get_my_root_and_depth()['root'] in isbcgc_projects:
                        confirmed_project_ids.append(proj.id)

            async_params = [ProviderClassQueryDescription(SeqPeekDataProvider, gnab_feature_id, cohort_id_array, confirmed_project_ids)]
            maf_data_result = get_feature_vectors_tcga_only(async_params, skip_formatting_for_plot=True)

            maf_data_vector = maf_data_result[gnab_feature_id]['data']

            if len(maf_data_vector) > 0:
                # Since the gene (hugo_symbol) parameter is part of the GNAB feature ID,
                # it will be sanity-checked in the SeqPeekMAFDataAccess instance.
                seqpeek_data = SeqPeekMAFDataFormatter().format_maf_vector_for_view(maf_data_vector, cohort_id_array)

                seqpeek_maf_vector = seqpeek_data.maf_vector
                seqpeek_cohort_info = seqpeek_data.cohort_info
                removed_row_statistics_dict = seqpeek_data.removed_row_statistics

                seqpeek_view_data = SeqPeekViewDataBuilder().build_view_data(hugo_symbol,
                                                                             seqpeek_maf_vector,
                                                                             seqpeek_cohort_info,
                                                                             cohort_id_array,
                                                                             removed_row_statistics_dict)

                response = self.create_response(seqpeek_view_data)
                return response
            else:
                # No data found
                return SeqPeekViewRecord(plot_data=SeqPeekViewPlotDataRecord(tracks=[], protein=None, regions=[]),
                                         hugo_symbol=hugo_symbol, cohort_id_list=[str(i) for i in cohort_id_array],
                                         removed_row_statistics=[])
        except Exception as e:
            logging.exception(e)
            raise InternalServerErrorException()

